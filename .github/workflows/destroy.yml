name: Destroy Infrastructure

on:
  push:
    branches:
      - 'feat/**'
      - 'dev/**'
    paths:
      - '.github/workflows/destroy.yml'
      - 'infra/terraform/**'
  schedule:
    # Destroy daily at 10 PM UTC
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  destroy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: us-east-1
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
      
      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init
      
      - name: Safety check - verify portfolio tag
        working-directory: ./infra/terraform
        run: |
          # `terraform output` only includes declared outputs, not resource tags.
          # Use state presence + known project markers as safety checks.
          if ! terraform state list > tfstate.list 2>/dev/null; then
            echo "✓ No Terraform state found - safe to continue"
          elif [ ! -s tfstate.list ]; then
            echo "✓ Terraform state is empty - safe to continue"
          else
            terraform show -json > tfshow.json
            if grep -Eq '"Purpose"[[:space:]]*:[[:space:]]*"portfolio"' tfshow.json; then
              echo "✓ Portfolio tag verified - safe to destroy"
            elif grep -Eiq 'startracker|/aws/apigateway/startracker' tfshow.json; then
              echo "✓ State contains StarTracker resources - safe to destroy"
            else
              echo "✗ Non-empty state does not appear to be StarTracker/portfolio - aborting destroy"
              exit 1
            fi
          fi

      - name: Terraform Destroy Plan (safe preview only)
        if: github.event_name == 'push'
        working-directory: ./infra/terraform
        run: |
          terraform plan -destroy \
            -var="region=us-east-1" \
            -var="environment=dev" \
            -var="image_tag=latest" \
            -var="api_key=${{ secrets.API_KEY }}" \
            -out=tfdestroyplan
      
      - name: Terraform Destroy
        if: github.event_name != 'push'
        working-directory: ./infra/terraform
        run: |
          terraform destroy \
            -var="region=us-east-1" \
            -var="environment=dev" \
            -var="image_tag=latest" \
            -var="api_key=${{ secrets.API_KEY }}" \
            -auto-approve

      - name: Verify teardown leftovers
        if: always() && github.event_name != 'push'
        shell: pwsh
        run: |
          ./scripts/destroy-verify.ps1 -Region us-east-1 -ClusterName startracker-eks-dev -NameFilter startracker
      
      - name: Notification
        if: always()
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "## Destroy Preview Complete" >> $GITHUB_STEP_SUMMARY
            echo "Branch push executed a destroy plan only (no resources destroyed)." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "Scheduled or manual destruction completed." >> $GITHUB_STEP_SUMMARY
            echo "Teardown verification ran via scripts/destroy-verify.ps1." >> $GITHUB_STEP_SUMMARY
          fi
