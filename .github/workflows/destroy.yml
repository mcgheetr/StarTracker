name: Destroy Infrastructure

on:
  push:
    branches:
      - 'feat/**'
      - 'dev/**'
    paths:
      - '.github/workflows/destroy.yml'
      - 'infra/terraform/**'
  schedule:
    # Destroy daily at 10 PM UTC
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  destroy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: us-east-1
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
      
      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init
      
      - name: Safety check - verify portfolio tag
        working-directory: ./infra/terraform
        run: |
          # Deterministic safety check:
          # Allow destroy only when state is empty or contains only known StarTracker addresses.
          if ! terraform state list > tfstate.list 2>/dev/null; then
            echo "✓ No Terraform state found - safe to continue"
          elif [ ! -s tfstate.list ]; then
            echo "✓ Terraform state is empty - safe to continue"
          else
            ALLOWED='^(aws_apigatewayv2_api\.startracker|aws_apigatewayv2_stage\.default|aws_cloudwatch_log_group\.api_gateway|aws_ecr_repository\.startracker|aws_ecr_lifecycle_policy\.startracker|aws_lambda_function\.startracker|aws_iam_role\.lambda|aws_iam_role_policy_attachment\.lambda_basic|aws_iam_role_policy\.lambda_dynamodb|aws_apigatewayv2_integration\.lambda|aws_apigatewayv2_route\.lambda_default|aws_lambda_permission\.api_gateway|aws_dynamodb_table\.observations)$'
            if grep -Ev "$ALLOWED" tfstate.list > unexpected.list; then
              echo "✗ Found unexpected Terraform state addresses; aborting destroy"
              cat unexpected.list
              exit 1
            fi
            echo "✓ State contains only expected StarTracker resources - safe to destroy"
          fi

      - name: Terraform Destroy Plan (safe preview only)
        if: github.event_name == 'push'
        working-directory: ./infra/terraform
        run: |
          terraform plan -destroy \
            -var="region=us-east-1" \
            -var="environment=dev" \
            -var="image_tag=latest" \
            -var="api_key=${{ secrets.API_KEY }}" \
            -out=tfdestroyplan
      
      - name: Terraform Destroy
        if: github.event_name != 'push'
        working-directory: ./infra/terraform
        run: |
          terraform destroy \
            -var="region=us-east-1" \
            -var="environment=dev" \
            -var="image_tag=latest" \
            -var="api_key=${{ secrets.API_KEY }}" \
            -auto-approve

      - name: Verify teardown leftovers
        if: always() && github.event_name != 'push'
        shell: pwsh
        run: |
          ./scripts/destroy-verify.ps1 -Region us-east-1 -ClusterName startracker-eks-dev -NameFilter startracker
      
      - name: Notification
        if: always()
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "## Destroy Preview Complete" >> $GITHUB_STEP_SUMMARY
            echo "Branch push executed a destroy plan only (no resources destroyed)." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "Scheduled or manual destruction completed." >> $GITHUB_STEP_SUMMARY
            echo "Teardown verification ran via scripts/destroy-verify.ps1." >> $GITHUB_STEP_SUMMARY
          fi
